---
title: "Diagnostic atlas of variation"
output:
  pdf_document: default
  html_notebook: default
  html_document: default
editor_options:
  chunk_output_type: inline
---

# Introduction

```{r}
knitr::opts_chunk$set(cache = TRUE, echo = FALSE, warning = FALSE, message = FALSE)

library(dplyr)
library(ggplot2)
library(govstyle)
if(!require("factoextra"))install.packages("factoextra")
library(factoextra)
if(!require("FactoMineR"))install.packages("FactoMineR")
library(FactoMineR)
gov_cols

```


Created a file of CCG data from the Diagnostic Atlas of Variation

```{r}
aov <- readr::read_csv("aov.csv", col_types = c("cccdddddic"))
```

## Structure of the data

The file contains:

1. Data for 17 CCG maps
2. Three type of time periods - quarterly, annual and three yearly

This is summarised in table 1.

```{r}


aov %>%
  group_by(map, Period) %>%
  count() %>%
  tidyr::spread(map, n) %>%
  knitr::kable(caption = "Table1: Available time periods for each indicator; CCG counts")

### need to check map 24 and map 25
  





```


## Comparison of endoscopic procedures

I am going to compare rates of utilisation of radiological, endoscopic and related procedures - these are included in maps 16, 17, 19, 20 and 22.



```{r}
 aov_endo <- aov %>%
  filter(map %in% c("Map 1: Rate of computed axial tomography (CT) activity per weighted population by CCG",
                    "Map 2: Rate of magnetic resonance imaging (MRI) activity per weighted population by CCG",
                    "Map 16: Rate of colonoscopy procedures and flexible sigmoidoscopy procedures per population by CCG", 
                    "Map 17: Rate of computed tomography (CT) colonography procedures per weighted population by CCG", 
         "Map 19: Rate of gastroscopy (upper gastrointestinal endoscopy) procedures per population by CCG" , 
         "Map 20: Percentage of patients undergoing gastroscopy (upper gastrointestinal endoscopy) procedures aged under 55 years by CCG", 
         "Map 22: Rate of endoscopic ultrasound procedures per population by CCG"))

head(aov_endo)


```


### Plot trends



```{r fig.height=8, fig.width=6, fig.cap= "Trends in rates of endoscopy and imaging"}
aov_endo %>%
  filter(!stringr::str_detect(Period, "Q"))%>%
  ggplot(aes(Period, Rate)) +
  geom_boxplot(notch = TRUE, fill = "#2B8CC4") +
  facet_wrap(~map, scales = "free", labeller = label_wrap_gen(30)) +
  theme_gov() +
  theme(axis.text.x = element_text(angle= 45, hjust= 1, size = rel(.9)), 
        strip.text.x = element_text(size = 8))




```


```{r fig.height=6, fig.width=6, fig.cap= "Trends in rates of endoscopy and imaging - quarterly data"}

aov_endo %>%
  filter(stringr::str_detect(Period, "Q"))%>%
  ggplot(aes(Period, Rate)) +
  geom_boxplot(notch = TRUE, fill = "#2B8CC4") +
  facet_wrap(~map, scales = "free", labeller = label_wrap_gen(30)) +
  theme_gov() +
  theme(axis.text.x = element_text(angle= 45, hjust= 1, size = rel(.9)), 
        strip.text.x = element_text(size = 8))

```

## Correlations

```{r}
## latest data
aov_endo %>%
  filter(!stringr::str_detect(Period, "Q")) %>%
  group_by(map) %>%
  arrange(desc(Period)) %>%
  slice(1) %>%
  mutate(index = paste(Period, "-", map)) %>%
  select(index) %>%
  ungroup() -> latest_data

aov_latest <- aov_endo %>%
    filter(!stringr::str_detect(Period, "Q")) %>%
    mutate(index = paste(Period, "-", map)) %>%
    filter(index %in% latest_data$index)

aov_latest_wide <- aov_latest %>%
  select(index, `CCG code`, `CCG name`, Rate) %>%
  tidyr::spread(index, Rate) %>% data.frame() %>% na.omit()

colnames(aov_latest_wide) <- substring(colnames(aov_latest_wide), 1, 20)


rownames(aov_latest_wide) <- aov_latest_wide$`CCG name`

library(corrr)

correlate(aov_latest_wide[,-c(1:2)]) %>% rearrange(method = "HC", absolute = TRUE) %>% fashion()

aov_scale_wide <- purrr::map(aov_latest_wide[, -c(1:2)], scale) %>% data.frame() %>% na.omit()

mean(is.na(aov_scale_wide))

set.seed(123)

  fviz_nbclust(aov_scale_wide, kmeans, method = "gap_stat")

aov_k <- kmeans(aov_scale_wide, 3, nstart = 25, iter.max = 15)


fviz_cluster(aov_k, aov_latest_wide[, -c(1:2)], ellipse.type = "norm") + 
geom_text(label = aov_latest_wide$CCG.name, size = 2) 

aov_pca <- PCA(aov_latest_wide[, -c(1:2)])

fviz_contrib(aov_pca, choice = "var", axes = 1)

fviz_contrib(aov_pca, choice = "var", axes = 2)


```

